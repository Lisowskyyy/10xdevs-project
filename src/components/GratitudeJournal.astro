---
// src/components/GratitudeJournal.astro
---

<div class="max-w-2xl mx-auto mt-8 p-6 bg-slate-800/50 rounded-xl border border-gold/20 shadow-lg backdrop-blur-sm">
  <h2 class="text-2xl font-light text-gold mb-4 font-serif">Dziennik Wdzięczności</h2>

  <form id="journalForm" class="space-y-4">
    <div class="relative">
      <textarea
        id="journalEntry"
        name="entry"
        rows="4"
        placeholder="Za co jesteś dzisiaj wdzięczny? (Nasionko słucha...)"
        class="w-full bg-slate-900/50 border border-slate-700 rounded-lg p-4 text-slate-200 placeholder-slate-500 focus:border-gold/50 focus:ring-1 focus:ring-gold/50 transition-all resize-none"
        required></textarea>

      <!-- Loader (domyślnie ukryty) -->
      <div id="loader" class="absolute inset-0 bg-slate-900/80 rounded-lg flex items-center justify-center hidden">
        <div class="flex flex-col items-center">
          <div class="w-8 h-8 border-2 border-gold border-t-transparent rounded-full animate-spin"></div>
          <p class="text-xs text-gold mt-2 animate-pulse">Analizuję Twoje myśli...</p>
        </div>
      </div>
    </div>

    <div class="flex justify-end">
      <button
        type="submit"
        class="px-6 py-2 bg-gradient-to-r from-gold/80 to-gold text-slate-900 font-medium rounded-lg hover:shadow-[0_0_15px_rgba(255,215,0,0.3)] transition-all transform hover:-translate-y-0.5"
      >
        Zapisz i Poczuj ✨
      </button>
    </div>
  </form>

  <!-- Sekcja odpowiedzi AI (domyślnie ukryta) -->
  <div id="aiResponse" class="mt-6 hidden opacity-0 transition-opacity duration-700">
    <div class="p-4 bg-purple-900/20 border-l-2 border-purple-400 rounded-r-lg">
      <h3 class="text-sm font-bold text-purple-300 mb-1 uppercase tracking-wider">Refleksja Veranimy</h3>
      <p id="aiText" class="text-slate-300 italic leading-relaxed"></p>
    </div>
  </div>
</div>

<!-- eslint-disable prettier/prettier -->
<script is:inline>
  // Logika po stronie klienta (Client-Side)
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("journalForm");
    const loader = document.getElementById("loader");
    const aiResponse = document.getElementById("aiResponse");
    const aiText = document.getElementById("aiText");

    if (form && form instanceof HTMLFormElement) {
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const entryElement = document.getElementById("journalEntry");
        const entry = entryElement && entryElement instanceof HTMLTextAreaElement ? entryElement.value : "";

        // UI: Pokaż loader
        if (loader) loader.classList.remove("hidden");
        if (aiResponse) {
          aiResponse.classList.add("hidden");
          aiResponse.classList.remove("opacity-100");
        }

        // Wywołanie naszego Endpointu API
        // Pobieramy ID użytkownika z sesji Supabase (zarządzane przez endpoint, tu wysyłamy tylko tekst)
        fetch("/api/journal", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text: entry }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              // UI: Sukces
              if (aiText) aiText.textContent = `"${data.aiResponse}"`;
              if (aiResponse) {
                aiResponse.classList.remove("hidden");
                // Małe opóźnienie dla efektu fade-in
                setTimeout(() => {
                  aiResponse.classList.add("opacity-100");
                }, 50);
              }
              form.reset();
            } else {
              alert("Coś poszło nie tak: " + (data.error || "Błąd nieznany"));
            }
          })
          .catch(() => {
            // Error handling - user-friendly message
            alert("Błąd połączenia z Veranimą.");
          })
          .finally(() => {
            if (loader) loader.classList.add("hidden");
          });
      });
    }
  });
</script>
<!-- eslint-enable prettier/prettier -->
