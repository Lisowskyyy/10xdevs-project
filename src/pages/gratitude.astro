---
// src/pages/gratitude.astro
import Layout from "../layouts/Layout.astro";
import { createServerSupabaseClient } from "../lib/supabase";

const supabase = createServerSupabaseClient(Astro.cookies);

// Pobierz aktualnego użytkownika
const {
  data: { session },
} = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect("/login");
}

// Pobieranie Historii Wdzięczności z Bazy
// Sortujemy malejąco (najnowsze na górze)
const { data: entries } = await supabase
  .from("gratitude_entries")
  .select("*")
  .eq("user_id", session.user.id)
  .order("created_at", { ascending: false });
---

<Layout title="Dziennik Wdzięczności | Veranima">
  <main class="min-h-screen bg-slate-950 text-slate-200 py-12 px-4">
    <div class="max-w-4xl mx-auto">
      <!-- Nagłówek -->
      <header class="mb-12 text-center">
        <h1 class="text-4xl font-serif text-gold mb-4">Ścieżka Wdzięczności</h1>
        <p class="text-slate-400 max-w-lg mx-auto">
          Tutaj gromadzą się Twoje promienie światła. Każdy wpis to krok ku wewnętrznej harmonii.
        </p>
      </header>

      <!-- Lista Wpisów -->
      <div class="space-y-8">
        {
          entries && entries.length > 0 ? (
            entries.map((entry) => (
              <div class="bg-slate-900/50 border border-slate-800 rounded-xl p-6 hover:border-gold/30 transition-colors duration-300">
                <div class="flex flex-col md:flex-row md:items-start justify-between gap-4 mb-4">
                  <div class="flex-1">
                    <p class="text-lg text-slate-200 font-light italic">"{entry.content}"</p>
                  </div>
                  <div class="text-xs text-slate-500 font-mono whitespace-nowrap">
                    {new Date(entry.created_at).toLocaleDateString("pl-PL", {
                      weekday: "long",
                      year: "numeric",
                      month: "long",
                      day: "numeric",
                    })}
                  </div>
                </div>

                {entry.ai_response && (
                  <div class="mt-4 pt-4 border-t border-slate-800/50">
                    <div class="flex gap-3 items-start">
                      <div class="text-xl">✨</div>
                      <div>
                        <span class="text-xs font-bold text-purple-400 uppercase tracking-widest block mb-1">
                          Głos Veranimy
                        </span>
                        <p class="text-purple-200/90 text-sm leading-relaxed">{entry.ai_response}</p>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            ))
          ) : (
            <div class="text-center py-20 bg-slate-900/30 rounded-xl border border-dashed border-slate-800">
              <p class="text-slate-500 mb-4">Twoja księga jest jeszcze pusta.</p>
              <a href="/dashboard" class="text-gold hover:text-gold/80 underline underline-offset-4">
                Dodaj pierwszy promień na Dashboardzie &rarr;
              </a>
            </div>
          )
        }
      </div>
    </div>
  </main>
</Layout>
