---
// src/pages/gratitude.astro
import Layout from "../layouts/Layout.astro";
import { createServerSupabaseClient } from "../lib/supabase";

const supabase = createServerSupabaseClient(Astro.cookies);

// Pobierz aktualnego uÅ¼ytkownika
const {
  data: { session },
} = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect("/login");
}

// Pobieranie Historii WdziÄ™cznoÅ›ci z Bazy
// Sortujemy malejÄ…co (najnowsze na gÃ³rze)
const { data: entries } = await supabase
  .from("gratitude_entries")
  .select("*")
  .eq("user_id", session.user.id)
  .order("created_at", { ascending: false });
---

<Layout title="Dziennik WdziÄ™cznoÅ›ci | Veranima">
  <main class="min-h-screen" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
    <div class="max-w-4xl mx-auto py-12 px-4">
      <!-- Back Button -->
      <div class="mb-8">
        <a
          href="/dashboard"
          class="inline-flex items-center gap-2 text-slate-300 hover:text-[#d4af37] transition-colors duration-300 group"
        >
          <span class="text-xl group-hover:-translate-x-1 transition-transform duration-300">â†</span>
          <span class="text-sm font-medium">Back to Sanctuary</span>
        </a>
      </div>

      <!-- NagÅ‚Ã³wek -->
      <header class="mb-12 text-center">
        <h1
          class="text-4xl font-serif mb-4"
          style="background: linear-gradient(135deg, #d4af37 0%, #f4e5c3 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"
        >
          ÅšcieÅ¼ka WdziÄ™cznoÅ›ci
        </h1>
        <p class="text-slate-300 max-w-lg mx-auto">
          Tutaj gromadzÄ… siÄ™ Twoje promienie Å›wiatÅ‚a. KaÅ¼dy wpis to krok ku wewnÄ™trznej harmonii.
        </p>
      </header>

      <!-- Lista WpisÃ³w -->
      <div class="space-y-8">
        {
          entries && entries.length > 0 ? (
            entries.map((entry) => (
              <div
                class="js-entry relative bg-gradient-to-br from-slate-900 to-slate-800 border border-[#d4af37]/20 rounded-xl p-6 hover:border-[#d4af37]/40 transition-all duration-300 shadow-lg hover:shadow-xl hover:shadow-[#d4af37]/10"
                data-entry-id={entry.id}
              >
                <div class="flex flex-col md:flex-row md:items-start justify-between gap-4 mb-4">
                  <div class="flex-1">
                    <p class="text-xl md:text-2xl text-slate-100 font-serif leading-relaxed italic">
                      "{entry.content}"
                    </p>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-xs text-slate-300 font-mono whitespace-nowrap opacity-80">
                      {new Date(entry.created_at).toLocaleDateString("pl-PL", {
                        weekday: "long",
                        year: "numeric",
                        month: "long",
                        day: "numeric",
                      })}
                    </span>
                    <button
                      type="button"
                      class="js-delete-entry flex-shrink-0 p-1.5 rounded-lg text-slate-400 hover:text-red-400 hover:bg-red-500/10 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-red-500/50"
                      data-entry-id={entry.id}
                      title="UsuÅ„ wpis"
                      aria-label="UsuÅ„ wpis"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="18"
                        height="18"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        aria-hidden="true"
                      >
                        <path d="M3 6h18" />
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
                        <line x1="10" y1="11" x2="10" y2="17" />
                        <line x1="14" y1="11" x2="14" y2="17" />
                      </svg>
                    </button>
                  </div>
                </div>

                {entry.ai_response && (
                  <div class="mt-6 pt-6 border-t border-slate-700/50">
                    <div class="relative bg-purple-900/20 rounded-lg p-5 backdrop-blur-sm border border-purple-500/20 shadow-[0_0_20px_rgba(147,51,234,0.15)]">
                      <div class="flex gap-3 items-start">
                        <div class="text-2xl">âœ¨</div>
                        <div class="flex-1">
                          <span class="text-xs font-bold text-purple-200 uppercase tracking-widest block mb-2">
                            GÅ‚os Veranimy
                          </span>
                          <p class="text-white text-sm md:text-base leading-relaxed">{entry.ai_response}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            ))
          ) : (
            <div
              class="text-center py-24 px-8 rounded-xl border border-dashed border-slate-700/50 backdrop-blur-sm"
              style="background: rgba(255, 255, 255, 0.02);"
            >
              <div class="text-6xl mb-6">ğŸ“œ</div>
              <h2
                class="text-2xl font-serif mb-3 text-slate-200"
                style="background: linear-gradient(135deg, #d4af37 0%, #f4e5c3 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;"
              >
                Twoja ksiÄ™ga jest jeszcze pusta
              </h2>
              <p class="text-slate-300 mb-8 max-w-md mx-auto leading-relaxed">
                KaÅ¼da podrÃ³Å¼ zaczyna siÄ™ od pierwszego kroku. Zapisz swÃ³j pierwszy promieÅ„ wdziÄ™cznoÅ›ci i pozwÃ³l, aby
                Å›wiatÅ‚o zaczÄ™Å‚o Å›wieciÄ‡.
              </p>
              <a
                href="/dashboard"
                class="inline-flex items-center gap-2 px-6 py-3 rounded-lg font-bold transition-all duration-300 hover:scale-105 backdrop-blur-sm bg-gradient-to-r from-yellow-500 to-amber-600 text-slate-900 hover:shadow-[0_0_20px_rgba(251,191,36,0.4)]"
              >
                <span>Zapisz pierwszy wpis</span>
                <span class="text-lg">â†’</span>
              </a>
            </div>
          )
        }
      </div>
    </div>
  </main>

  <script>
    /* eslint-disable */
    document.addEventListener("click", async (e) => {
      const target = e.target instanceof Element ? e.target : null;
      if (!target) return;
      const btn = target.closest(".js-delete-entry");
      if (!btn || !(btn instanceof HTMLButtonElement)) return;
      const id = btn.getAttribute("data-entry-id");
      if (!id) return;

      btn.disabled = true;
      btn.setAttribute("aria-busy", "true");

      try {
        const res = await fetch(`/api/journal/${id}`, { method: "DELETE" });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          alert(data?.error ?? "Nie udaÅ‚o siÄ™ usunÄ…Ä‡ wpisu.");
          btn.disabled = false;
          btn.removeAttribute("aria-busy");
          return;
        }
        const card = document.querySelector(`.js-entry[data-entry-id="${id}"]`);
        if (card) card.remove();
      } catch {
        alert("WystÄ…piÅ‚ bÅ‚Ä…d poÅ‚Ä…czenia.");
        btn.disabled = false;
        btn.removeAttribute("aria-busy");
      }
    });
  </script>
</Layout>
