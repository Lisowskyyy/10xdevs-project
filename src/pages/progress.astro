---
// src/pages/progress.astro
import Layout from "../layouts/Layout.astro";
import { createServerSupabaseClient } from "../lib/supabase";

const supabase = createServerSupabaseClient(Astro.cookies);

// SprawdÅº autentykacjÄ™
const {
  data: { session },
} = await supabase.auth.getSession();
if (!session) {
  return Astro.redirect("/login");
}

const user = session.user;

// Pobierz wszystkie wpisy
const { data: allEntries, count: totalEntries } = await supabase
  .from("journal_entries")
  .select("*", { count: "exact" })
  .eq("user_id", user.id)
  .order("created_at", { ascending: true });

// Oblicz total days (od pierwszego wpisu)
const totalDays =
  allEntries && allEntries.length > 0
    ? Math.ceil((new Date().getTime() - new Date(allEntries[0].created_at).getTime()) / (1000 * 60 * 60 * 24))
    : 0;

// Oblicz longest streak
let longestStreak = 0;
let currentStreakCalc = 0;
if (allEntries && allEntries.length > 0) {
  const dates = allEntries.map((e) => {
    const d = new Date(e.created_at);
    d.setHours(0, 0, 0, 0);
    return d.getTime();
  });

  const uniqueDates = [...new Set(dates)].sort((a, b) => a - b);

  currentStreakCalc = 1;
  longestStreak = 1;

  for (let i = 1; i < uniqueDates.length; i++) {
    const dayDiff = (uniqueDates[i] - uniqueDates[i - 1]) / (1000 * 60 * 60 * 24);

    if (dayDiff === 1) {
      currentStreakCalc++;
      longestStreak = Math.max(longestStreak, currentStreakCalc);
    } else {
      currentStreakCalc = 1;
    }
  }
}

// Pobierz ostatnie 90 dni dla heatmapy
const ninetyDaysAgo = new Date();
ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);

const { data: recentEntries } = await supabase
  .from("journal_entries")
  .select("created_at, mood")
  .eq("user_id", user.id)
  .gte("created_at", ninetyDaysAgo.toISOString())
  .order("created_at", { ascending: true });

// Przygotuj dane dla heatmapy (ostatnie 90 dni)
const heatmapData: Record<string, number> = {};
for (let i = 89; i >= 0; i--) {
  const date = new Date();
  date.setDate(date.getDate() - i);
  const dateStr = date.toISOString().split("T")[0];
  heatmapData[dateStr] = 0;
}

recentEntries?.forEach((entry) => {
  const dateStr = entry.created_at.split("T")[0];
  if (heatmapData[dateStr] !== undefined) {
    heatmapData[dateStr]++;
  }
});

// Mood trends (ostatnie 30 dni)
const thirtyDaysAgo = new Date();
thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

const { data: monthEntries } = await supabase
  .from("journal_entries")
  .select("mood, created_at")
  .eq("user_id", user.id)
  .gte("created_at", thirtyDaysAgo.toISOString());

const moodCounts: Record<string, number> = {};
monthEntries?.forEach((entry) => {
  moodCounts[entry.mood] = (moodCounts[entry.mood] || 0) + 1;
});

// Transmutation count
const { count: totalTransmutations } = await supabase
  .from("transmutation_events")
  .select("*", { count: "exact", head: true })
  .eq("user_id", user.id);

// Current Stage calculation (based on entries)
const getCurrentStage = (entries: number) => {
  if (entries < 10)
    return {
      name: "Nigredo",
      emoji: "ğŸŒ‘",
      color: "#4A5568",
      description: "The Dark Night - Beginning of transformation",
    };
  if (entries < 30)
    return {
      name: "Albedo",
      emoji: "ğŸŒ™",
      color: "#CBD5E0",
      description: "The Whitening - Purification phase",
    };
  if (entries < 60)
    return {
      name: "Citrinitas",
      emoji: "â˜€ï¸",
      color: "#F6AD55",
      description: "The Yellowing - Dawn of awareness",
    };
  return {
    name: "Rubedo",
    emoji: "ğŸ”´",
    color: "#FC8181",
    description: "The Reddening - Full integration",
  };
};

const currentStage = getCurrentStage(totalEntries || 0);

// Mood emoji mapping
const moodEmojiMap: Record<string, string> = {
  happy: "ğŸ˜Š",
  sad: "ğŸ˜¢",
  angry: "ğŸ˜ ",
  anxious: "ğŸ˜°",
  peaceful: "ğŸ˜Œ",
  grateful: "ğŸ™",
};
---

<Layout title="Progress - VERANIMA">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-12 min-h-screen">
    <!-- Hero Section -->
    <section class="text-center mb-12">
      <h1 class="text-4xl font-serif text-transparent bg-clip-text bg-gradient-to-r from-amber-200 to-yellow-500 mb-3">
        Twoja Statystyka
      </h1>
      <p class="text-slate-400 italic text-lg">Track your liberation and growth</p>
    </section>

    <!-- Hero Stats - Grid of Glass Cards -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
      <div
        class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl p-6 text-center transition-all hover:border-white/10 hover:shadow-lg hover:shadow-purple-900/20"
      >
        <div class="text-5xl font-bold text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.3)] mb-2">
          {totalEntries || 0}
        </div>
        <div class="text-xs text-amber-500/80 tracking-widest uppercase">Total Entries</div>
      </div>

      <div
        class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl p-6 text-center transition-all hover:border-white/10 hover:shadow-lg hover:shadow-purple-900/20"
      >
        <div class="text-5xl font-bold text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.3)] mb-2">
          {longestStreak}
        </div>
        <div class="text-xs text-amber-500/80 tracking-widest uppercase">Longest Streak</div>
      </div>

      <div
        class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl p-6 text-center transition-all hover:border-white/10 hover:shadow-lg hover:shadow-purple-900/20"
      >
        <div class="text-5xl font-bold text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.3)] mb-2">
          {totalDays}
        </div>
        <div class="text-xs text-amber-500/80 tracking-widest uppercase">Total Days</div>
      </div>

      <div
        class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl p-6 text-center transition-all hover:border-white/10 hover:shadow-lg hover:shadow-purple-900/20"
      >
        <div class="text-5xl font-bold text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.3)] mb-2">
          {totalTransmutations || 0}
        </div>
        <div class="text-xs text-amber-500/80 tracking-widest uppercase">Transmutations</div>
      </div>
    </section>

    <!-- Current Stage -->
    <section class="mb-12">
      <h2 class="text-2xl font-serif text-transparent bg-clip-text bg-gradient-to-r from-amber-200 to-yellow-500 mb-6">
        ğŸ­ Current Alchemical Stage
      </h2>
      <div
        class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl p-6 flex flex-col sm:flex-row gap-6 items-center"
        style={`border-left: 6px solid ${currentStage.color};`}
      >
        <div class="text-6xl">{currentStage.emoji}</div>
        <div class="flex-1 w-full">
          <h3 class="text-2xl font-bold text-white mb-2">{currentStage.name}</h3>
          <p class="text-slate-400 mb-4">{currentStage.description}</p>
          <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
            <div class="flex-1 bg-slate-800 rounded-full h-3 overflow-hidden">
              <div
                class="h-full bg-gradient-to-r from-purple-600 via-pink-600 to-amber-500 rounded-full transition-all duration-500"
                style={`width: ${Math.min((((totalEntries || 0) % 30) / 30) * 100, 100)}%;`}
              >
              </div>
            </div>
            <span class="text-sm text-slate-500 whitespace-nowrap">
              {(totalEntries || 0) % 30}/30 entries to next stage
            </span>
          </div>
        </div>
      </div>
    </section>

    <!-- Streak Calendar (Heatmap) -->
    <section
      class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl p-6 mb-12 shadow-lg shadow-purple-900/20"
    >
      <h2 class="text-2xl font-serif text-transparent bg-clip-text bg-gradient-to-r from-amber-200 to-yellow-500 mb-6">
        ğŸ”¥ Streak Calendar (Last 90 Days)
      </h2>
      <div class="grid grid-cols-13 gap-1 mb-4">
        {
          Object.entries(heatmapData).map(([date, count]) => {
            const intensity =
              count === 0
                ? "bg-slate-800/30"
                : count === 1
                  ? "bg-purple-600/40"
                  : count === 2
                    ? "bg-pink-600/60"
                    : "bg-amber-500/80";
            const textColor = count === 0 ? "text-slate-600" : "text-white";

            return (
              <div
                class={`aspect-square rounded border border-white/5 flex items-center justify-center text-xs font-semibold cursor-pointer transition-all hover:scale-110 hover:border-white/20 ${intensity} ${textColor}`}
                title={`${date}: ${count} ${count === 1 ? "entry" : "entries"}`}
                data-date={date}
              >
                <span>{count > 0 ? count : ""}</span>
              </div>
            );
          })
        }
      </div>
      <div class="flex items-center justify-center gap-2 text-slate-400 text-sm">
        <span>Less</span>
        <div class="w-4 h-4 rounded bg-slate-800/30 border border-white/5"></div>
        <div class="w-4 h-4 rounded bg-purple-600/40 border border-white/5"></div>
        <div class="w-4 h-4 rounded bg-pink-600/60 border border-white/5"></div>
        <div class="w-4 h-4 rounded bg-amber-500/80 border border-white/5"></div>
        <span>More</span>
      </div>
    </section>

    <!-- Mood Trends -->
    <section
      class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl p-6 mb-12 shadow-lg shadow-purple-900/20"
    >
      <h2 class="text-2xl font-serif text-transparent bg-clip-text bg-gradient-to-r from-amber-200 to-yellow-500 mb-6">
        ğŸ­ Mood Distribution (Last 30 Days)
      </h2>
      <div class="flex flex-col gap-6">
        {
          Object.entries(moodCounts).length > 0 ? (
            Object.entries(moodCounts).map(([mood, count]) => {
              const percentage = ((count / (monthEntries?.length || 1)) * 100).toFixed(1);
              const moodEmoji = moodEmojiMap[mood] || "ğŸ“";

              return (
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                  <div class="flex items-center gap-3 min-w-[150px]">
                    <span class="text-3xl">{moodEmoji}</span>
                    <span class="text-slate-300 font-semibold capitalize">{mood}</span>
                  </div>
                  <div class="flex-1 flex items-center gap-4 w-full">
                    <div class="flex-1 bg-slate-800 rounded-full h-8 overflow-hidden">
                      <div
                        class="h-full bg-gradient-to-r from-purple-600 via-pink-600 to-amber-500 rounded-full transition-all duration-500"
                        style={`width: ${percentage}%;`}
                      />
                    </div>
                    <span class="text-slate-300 font-semibold min-w-[50px] text-right">{percentage}%</span>
                  </div>
                </div>
              );
            })
          ) : (
            <p class="text-center py-8 text-slate-500">No mood data for the last 30 days. Start journaling! ğŸŒ±</p>
          )
        }
      </div>
    </section>

    <!-- Transformation Timeline -->
    <section
      class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl p-6 mb-12 shadow-lg shadow-purple-900/20"
    >
      <h2 class="text-2xl font-serif text-transparent bg-clip-text bg-gradient-to-r from-amber-200 to-yellow-500 mb-6">
        â³ Transformation Timeline
      </h2>
      <div class="relative pl-8">
        <div class="absolute left-2 top-0 bottom-0 w-0.5 bg-gradient-to-b from-purple-600 via-pink-600 to-amber-500">
        </div>
        {
          allEntries && allEntries.length > 0 ? (
            allEntries
              .slice(-10)
              .reverse()
              .map((entry) => {
                const date = new Date(entry.created_at);
                const moodEmoji = moodEmojiMap[entry.mood] || "ğŸ“";

                return (
                  <div class="relative mb-8 last:mb-0">
                    <div class="absolute -left-[34px] top-2 w-5 h-5 rounded-full bg-slate-950 border-2 border-purple-500 shadow-[0_0_10px_rgba(168,85,247,0.5)]" />
                    <div class="bg-slate-800/50 backdrop-blur-sm border border-white/5 rounded-xl p-4 hover:bg-slate-800/70 transition-colors">
                      <div class="flex items-center gap-3 mb-3">
                        <span class="text-2xl">{moodEmoji}</span>
                        <span class="text-slate-500 text-sm font-semibold">
                          {date.toLocaleDateString("pl-PL", {
                            day: "numeric",
                            month: "short",
                            year: "numeric",
                          })}
                        </span>
                      </div>
                      <p class="text-slate-300 leading-relaxed">{entry.content.slice(0, 100)}...</p>
                    </div>
                  </div>
                );
              })
          ) : (
            <p class="text-center py-8 text-slate-500">Your journey begins here. Write your first entry! ğŸŒ±</p>
          )
        }
      </div>
    </section>

    <!-- Monthly Stats -->
    <section
      class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl p-6 shadow-lg shadow-purple-900/20"
    >
      <h2 class="text-2xl font-serif text-transparent bg-clip-text bg-gradient-to-r from-amber-200 to-yellow-500 mb-6">
        ğŸ“ˆ This Month's Overview
      </h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div
          class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl p-6 text-center transition-all hover:border-white/10 hover:shadow-lg hover:shadow-purple-900/20"
        >
          <div class="text-5xl font-bold text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.3)] mb-2">
            {monthEntries?.length || 0}
          </div>
          <div class="text-xs text-amber-500/80 tracking-widest uppercase">Entries This Month</div>
        </div>
        <div
          class="bg-slate-900/50 backdrop-blur-md border border-white/5 rounded-2xl p-6 text-center transition-all hover:border-white/10 hover:shadow-lg hover:shadow-purple-900/20"
        >
          <div class="text-5xl font-bold text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.3)] mb-2">
            {(monthEntries?.length || 0) >= 20 ? "âœ…" : "â³"}
          </div>
          <div class="text-xs text-amber-500/80 tracking-widest uppercase">Monthly Goal (20)</div>
        </div>
      </div>
    </section>
  </div>
</Layout>

<style>
  .grid-cols-13 {
    grid-template-columns: repeat(13, minmax(0, 1fr));
  }

  @media (max-width: 768px) {
    .grid-cols-13 {
      grid-template-columns: repeat(7, minmax(0, 1fr));
    }
  }
</style>
